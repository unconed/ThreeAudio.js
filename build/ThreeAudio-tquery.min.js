var MicroEvent=function(){};MicroEvent.prototype={bind:function(b,a){this._events=this._events||{};this._events[b]=this._events[b]||[];this._events[b].push(a)},unbind:function(b,a){this._events=this._events||{};!1!==b in this._events&&this._events[b].splice(this._events[b].indexOf(a),1)},trigger:function(b){this._events=this._events||{};if(!1!==b in this._events)for(var a=0;a<this._events[b].length;a++)this._events[b][a].apply(this,Array.prototype.slice.call(arguments,1))}};
MicroEvent.mixin=function(b){for(var a=["bind","unbind","trigger"],d=0;d<a.length;d++)b.prototype[a[d]]=MicroEvent.prototype[a[d]]};"undefined"!==typeof module&&"exports"in module&&(module.exports=MicroEvent);(function(b){for(i in b)if(!window[i])throw"Error: ThreeAudio requires "+b[i];})({THREE:"Three.js",MicroEvent:"MicroEvent.js"});window.ThreeAudio=window.ThreeAudio||{};ThreeAudio.getShader=function(b){var a=document.getElementById(b);return a&&a.innerText||b};window._=window._||{};
_.each=_.each||function(b,a){if(b.forEach)return b.forEach(a);for(key in b)a(b[key],key,b)};_.extend=_.extend||function(b){_.each([].slice.call(arguments,1),function(a){for(var d in a)b[d]=a[d]});return b};MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};
MicroEvent.mixin=function(b){for(var a=["bind","unbind","trigger","on","emit"],d=0;d<a.length;d++)b.prototype[a[d]]=MicroEvent.prototype[a[d]]};ThreeAudio.Source=function(b){this.fftSize=b||1024;this.filters={};this.playing=false;this.init()};
ThreeAudio.Source.prototype={init:function(){var b=this.context=new webkitAudioContext;this.source=b.createBufferSource();this.analyser=b.createAnalyser();this.analyser.fftSize=this.fftSize;var a=this.filters;_.each({bass:{type:0,frequency:160,Q:1.2,gain:2},mid:{type:2,frequency:400,Q:1.2,gain:4},treble:{type:1,frequency:2E3,Q:1.2,gain:3}},function(c,d){var e=b.createBiquadFilter();e.key=d;e.type=c.type;e.frequency.value=c.frequency;e.Q.value=c.Q;e.analyser=b.createAnalyser();e.analyser.fftSize=512;
e.delayNode=b.createDelayNode();e.delayNode.delayTime.value=0;e.gainNode=b.createGainNode();e.gainNode.gain.value=c.gain;a[d]=e});this.delay=b.createDelayNode();this.delay.delayTime.value=this.fftSize*2/b.sampleRate;this.source.connect(this.analyser);this.analyser.connect(this.delay);this.delay.connect(b.destination);var d=this.source;_.each(a,function(a){d.connect(a.delayNode);a.delayNode.connect(a);a.connect(a.gainNode);a.gainNode.connect(a.analyser)});this.samples=this.analyser.frequencyBinCount;
this.data={freq:new Uint8Array(this.samples),time:new Uint8Array(this.samples),filter:{bass:new Uint8Array(256),mid:new Uint8Array(256),treble:new Uint8Array(256)}}},update:function(){var b=this.analyser,a=this.data;b.smoothingTimeConstant=0;b.getByteFrequencyData(a.freq);b.getByteTimeDomainData(a.time);_.each(this.filters,function(b){b.analyser.getByteTimeDomainData(a.filter[b.key])});return this},size:function(){return this.analyser.frequencyBinCount},load:function(b,a){var d=this.context,c=this.source,
f=new XMLHttpRequest;f.open("GET",b,true);f.responseType="arraybuffer";f.onload=function(){var b=d.createBuffer(f.response,false);c.buffer=b;c.loop=true;this.playing&&this._play();a&&a()}.bind(this);f.send();return this},play:function(){this.playing=true;this.source.buffer&&this._play();return this},stop:function(){this.playing=false;this.source.buffer&&this._stop();return this},_play:function(){this.source.noteOn(0)},_stop:function(){this.source.noteOff(0)}};
ThreeAudio.Material=function(b,a,d,c,f,e){var e=e||[],f=_.extend(f||{},{audioLevels:{type:"fv1",value:0},audioLevelsSmooth:{type:"fv1",value:0},audioLevelsChange:{type:"fv1",value:0},audioOffset:{type:"f",value:0},audioStep:{type:"v2",value:{x:0,y:0}}}),g=0;_.each(b.get(),function(a,b){var c=new THREE.Texture(new Image,new THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.RepeatWrapping,THREE.NearestFilter,THREE.NearestFilter);c.__webglInit=true;c.__webglTexture=a;f[b+"Data"]={type:"t",texture:c,value:g++}});
_.each(c||[],function(a,b){f[b]={type:"t",value:g++,texture:a}});b.on("update",function(a){_.each(a,function(a,b){f[b].value=a})});return new THREE.ShaderMaterial({attributes:e,uniforms:f,vertexShader:ThreeAudio.getShader(a),fragmentShader:ThreeAudio.getShader(d)})};ThreeAudio.Textures=function(b,a,d){this.renderer=b;this.source=a;this.textures={};this.materials=[];this.history=d||128;this.timeIndex=0;this.init()};
ThreeAudio.Textures.prototype={init:function(){var b=this.renderer,a=b.getContext(),d=this.textures,c=this.source,f=this.history,e,g,j;_.each(["freq","time"],function(h){if(d[h]){a.deleteTexture(d[h]);b.info.memory.textures--}e=d[h]=a.createTexture();b.info.memory.textures++;a.bindTexture(a.TEXTURE_2D,e);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.REPEAT);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,
a.TEXTURE_MAG_FILTER,a.LINEAR);g=c.data[h];j=new Uint8Array(g.length*f);if(h=="time")for(h=0;h<g.length*f;++h)j[h]=128;a.texImage2D(a.TEXTURE_2D,0,a.ALPHA,g.length,f,0,a.ALPHA,a.UNSIGNED_BYTE,j)});this.audioLevels=[[1,0,0,0]];this.audioLevelsSmooth=[0,0,0,0];this.audioLevelsChange=[0,0,0,0]},update:function(){function b(a){for(var b=a.length,c=0,d=0;d<b;++d)var e=(a[d]-128)/128,c=c+e*e;return c/b}var a=this.renderer.getContext(),d=this.textures,c=this.source,f=this.history,e=this.timeIndex,g=c.data;
levels=this.audioLevels;smooth=this.audioLevelsSmooth;change=this.audioLevelsChange;bins=[0,0,0,0];c.update();for(var j=[g.time,g.filter.bass,g.filter.mid,g.filter.treble],c=0;c<4;++c)bins[c]=Math.sqrt(b(j[c]));levels.unshift(bins);levels.length>7&&levels.pop();var h,l,m;h=[1,2,1];l=4;m=Math.min(levels.length,h.length);for(var k=0;k<4;++k){for(c=j=0;c<m;++c)j=j+(levels[c]&&levels[c][k]||0)*h[c];smooth[k]=j/l}h=[1,3,2,-2,-3,-1];l=6;Math.min(levels.length,h.length);for(k=0;k<4;++k){for(c=j=0;c<m;++c)j=
j+(levels[c]&&levels[c][k]||0)*h[c];change[k]=change[k]+(j/l-change[k])*0.3}_.each(["freq","time"],function(b){a.bindTexture(a.TEXTURE_2D,d[b]);a.pixelStorei(a.UNPACK_ALIGNMENT,1);a.texSubImage2D(a.TEXTURE_2D,0,0,e,g[b].length,1,a.ALPHA,a.UNSIGNED_BYTE,g[b])});this.emit("update",this.uniforms());this.timeIndex=(e+1)%f},get:function(){return this.textures},uniforms:function(){return{audioLevels:this.audioLevels[0],audioLevelsSmooth:this.audioLevelsSmooth,audioLevelsChange:this.audioLevelsChange,audioOffset:this.timeIndex/
this.history,audioStep:{x:1/(this.source.samples-1),y:1/this.history}}}};MicroEvent.mixin(ThreeAudio.Textures);ThreeAudio.GridGeometry=function(b,a,d,c,f){var e=b.source,c=(c||e.samples)-1,f=Math.min(b.history,f||b.history)-1,g=f/b.history,j=0.5/(e.samples-1);offsetV=0.5/b.history;b=new THREE.PlaneGeometry(a,d,c,f);_.each(b.faceVertexUvs[0],function(a){_.each(a,function(a){a.u=a.u+j;a.v=1-a.v*g+offsetV})});return b};
tQuery.register("createAudio",function(b){var a=this,b=new ThreeAudio.Source(b);b.textures=function(b){return a.createAudioTextures(this,b)};return b});tQuery.register("createAudioTextures",function(b,a){var d=this,c=new ThreeAudio.Textures(this._renderer,b,a);c.material=function(a,b,c,j,h){return d.createAudioMaterial(this,a,b,c,j,h)};return c});
tQuery.register("createAudioMaterial",function(b,a,d,c,f,e){var g=this,a=new ThreeAudio.Material(b,a,d,c,f,e);a.grid=function(a,c,d,e){return g.createAudioGrid(b,a,c,d,e,this)};return a});tQuery.register("createAudioGrid",function(b){return this._createMesh(ThreeAudio.GridGeometry,[b,1,1,0,0],arguments)});
