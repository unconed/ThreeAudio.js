var MicroEvent=function(){};MicroEvent.prototype={bind:function(a,c){this._events=this._events||{};this._events[a]=this._events[a]||[];this._events[a].push(c)},unbind:function(a,c){this._events=this._events||{};!1!==a in this._events&&this._events[a].splice(this._events[a].indexOf(c),1)},trigger:function(a){this._events=this._events||{};if(!1!==a in this._events)for(var c=0;c<this._events[a].length;c++)this._events[a][c].apply(this,Array.prototype.slice.call(arguments,1))}};
MicroEvent.mixin=function(a){for(var c=["bind","unbind","trigger"],f=0;f<c.length;f++)a.prototype[c[f]]=MicroEvent.prototype[c[f]]};"undefined"!==typeof module&&"exports"in module&&(module.exports=MicroEvent);var DSP={LEFT:0,RIGHT:1,MIX:2,SINE:1,TRIANGLE:2,SAW:3,SQUARE:4,LOWPASS:0,HIGHPASS:1,BANDPASS:2,NOTCH:3,BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10,OFF:0,FW:1,BW:2,FWBW:3,TWO_PI:2*Math.PI};
function FourierTransform(a,c){this.bufferSize=a;this.sampleRate=c;this.bandwidth=2/a*c/2;this.spectrum=new Float32Array(a/2);this.real=new Float32Array(a);this.imag=new Float32Array(a);this.peak=this.peakBand=0;this.getBandFrequency=function(a){return this.bandwidth*a+this.bandwidth/2};this.calculateSpectrum=function(){for(var c=this.spectrum,e=this.real,d=this.imag,n=2/this.bufferSize,k=Math.sqrt,g,m,s=0,p=a/2;s<p;s++)g=e[s],m=d[s],g=n*k(g*g+m*m),g>this.peak&&(this.peakBand=s,this.peak=g),c[s]=
g}}function DFT(a,c){FourierTransform.call(this,a,c);var f=a/2*a,e=2*Math.PI;this.sinTable=new Float32Array(f);this.cosTable=new Float32Array(f);for(var d=0;d<f;d++)this.sinTable[d]=Math.sin(d*e/a),this.cosTable[d]=Math.cos(d*e/a)}DFT.prototype.forward=function(a){for(var c=this.real,f=this.imag,e,d,n=0;n<this.bufferSize/2;n++){for(var k=d=e=0;k<a.length;k++)e+=this.cosTable[n*k]*a[k],d+=this.sinTable[n*k]*a[k];c[n]=e;f[n]=d}return this.calculateSpectrum()};
function FFT(a,c){FourierTransform.call(this,a,c);this.reverseTable=new Uint32Array(a);for(var f=1,e=a>>1,d;f<a;){for(d=0;d<f;d++)this.reverseTable[d+f]=this.reverseTable[d]+e;f<<=1;e>>=1}this.sinTable=new Float32Array(a);this.cosTable=new Float32Array(a);for(d=0;d<a;d++)this.sinTable[d]=Math.sin(-Math.PI/d),this.cosTable[d]=Math.cos(-Math.PI/d)}
FFT.prototype.forward=function(a){var c=this.bufferSize,f=this.cosTable,e=this.sinTable,d=this.reverseTable,n=this.real,k=this.imag,g=Math.floor(Math.log(c)/Math.LN2);if(Math.pow(2,g)!==c)throw"Invalid buffer size, must be a power of 2.";if(c!==a.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+c+" Buffer Size: "+a.length;var g=1,m,s,p,q,t,h;for(h=0;h<c;h++)n[h]=a[d[h]],k[h]=0;for(;g<c;){a=f[g];d=e[g];m=1;for(var w=s=0;w<g;w++){for(h=w;h<c;)p=h+g,q=m*n[p]-s*k[p],t=m*k[p]+
s*n[p],n[p]=n[h]-q,k[p]=k[h]-t,n[h]+=q,k[h]+=t,h+=g<<1;h=m;m=h*a-s*d;s=h*d+s*a}g<<=1}return this.calculateSpectrum()};
FFT.prototype.inverse=function(a,c){var f=this.bufferSize,e=this.cosTable,d=this.sinTable,n=this.reverseTable;a=a||this.real;c=c||this.imag;var k=1,g,m,s,p,q,t,h;for(h=0;h<f;h++)c[h]*=-1;g=new Float32Array(f);m=new Float32Array(f);for(h=0;h<a.length;h++)g[h]=a[n[h]],m[h]=c[n[h]];a=g;for(c=m;k<f;){n=e[k];g=d[k];m=1;for(var w=s=0;w<k;w++){for(h=w;h<f;)p=h+k,q=m*a[p]-s*c[p],t=m*c[p]+s*a[p],a[p]=a[h]-q,c[p]=c[h]-t,a[h]+=q,c[h]+=t,h+=k<<1;h=m;m=h*n-s*g;s=h*g+s*n}k<<=1}e=new Float32Array(f);for(h=0;h<f;h++)e[h]=
a[h]/f;return e};
function RFFT(a,c){FourierTransform.call(this,a,c);this.trans=new Float32Array(a);this.reverseTable=new Uint32Array(a);this.reverseBinPermute=function(a,c){var d=this.bufferSize,n=d>>>1,d=d-1,k=1,g=0,m;a[0]=c[0];do{g+=n;a[k]=c[g];a[g]=c[k];k++;for(m=n<<1;m>>=1,!((g^=m)&m););g>=k&&(a[k]=c[g],a[g]=c[k],a[d-k]=c[d-g],a[d-g]=c[d-k]);k++}while(k<n);a[d]=c[d]};this.generateReverseTable=function(){var a=this.bufferSize,c=a>>>1,a=a-1,d=1,n=0,k;this.reverseTable[0]=0;do{n+=c;this.reverseTable[d]=n;this.reverseTable[n]=
d;d++;for(k=c<<1;k>>=1,!((n^=k)&k););n>=d&&(this.reverseTable[d]=n,this.reverseTable[n]=d,this.reverseTable[a-d]=a-n,this.reverseTable[a-n]=a-d);d++}while(d<c);this.reverseTable[a]=a};this.generateReverseTable()}
RFFT.prototype.forward=function(a){var c=this.bufferSize,f=this.spectrum,e=this.trans,d=2*Math.PI,n=Math.sqrt,k=c>>>1,g=2/c,m,s,p,q,t,h,w,r,y,u,x,z,E,F,H,B,C,D,I,J,K;this.reverseBinPermute(e,a);q=0;for(var A=4;q<c;A*=4){for(var v=q;v<c;v+=A)B=e[v]-e[v+1],e[v]+=e[v+1],e[v+1]=B;q=2*(A-1)}a=2;for(p=c>>>1;p>>>=1;){q=0;a<<=1;A=a<<1;m=a>>>2;s=a>>>3;do{if(1!==m)for(v=q;v<c;v+=A)r=v,y=r+m,u=y+m,x=u+m,q=e[u]+e[x],e[x]-=e[u],e[u]=e[r]-q,e[r]+=q,r+=s,y+=s,u+=s,x+=s,q=e[u]+e[x],t=e[u]-e[x],q=-q*Math.SQRT1_2,
t*=Math.SQRT1_2,B=e[y],e[x]=q+B,e[u]=q-B,e[y]=e[r]-t,e[r]+=t;else for(v=q;v<c;v+=A)r=v,y=r+m,u=y+m,x=u+m,q=e[u]+e[x],e[x]-=e[u],e[u]=e[r]-q,e[r]+=q;q=(A<<1)-a;A<<=2}while(q<c);K=d/a;for(var G=1;G<s;G++){C=G*K;D=Math.sin(C);C=Math.cos(C);I=4*C*(C*C-0.75);J=4*D*(0.75-D*D);q=0;A=a<<1;do{for(v=q;v<c;v+=A)r=v+G,y=r+m,u=y+m,x=u+m,z=v+m-G,E=z+m,F=E+m,H=F+m,t=e[F]*C-e[u]*D,q=e[F]*D+e[u]*C,w=e[H]*I-e[x]*J,h=e[H]*J+e[x]*I,B=t-w,t+=w,w=B,e[H]=t+e[E],e[u]=t-e[E],B=h-q,q+=h,h=B,e[x]=h+e[y],e[F]=h-e[y],e[E]=e[r]-
q,e[r]+=q,e[y]=w+e[z],e[z]-=w;q=(A<<1)-a;A<<=2}while(q<c)}}for(;--k;)d=e[k],a=e[c-k-1],d=g*n(d*d+a*a),d>this.peak&&(this.peakBand=k,this.peak=d),f[k]=d;f[0]=g*e[0];return f};(function(a){for(var c in a)if(!window[c])throw"Error: ThreeAudio requires "+a[c];})({THREE:"Three.js",MicroEvent:"MicroEvent.js"});window.ThreeAudio=window.ThreeAudio||{};ThreeAudio.getShader=function(a){var c=document.getElementById(a);return c&&(c.innerText||c.textContent)||a};window._=window._||{};
_.each=_.each||function(a,c){if(a.forEach)return a.forEach(c);for(key in a)c(a[key],key,a)};_.extend=_.extend||function(a){_.each([].slice.call(arguments,1),function(c){for(var f in c)a[f]=c[f]});return a};MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};
MicroEvent.mixin=function(a){for(var c=["bind","unbind","trigger","on","emit"],f=0;f<c.length;f++)a.prototype[c[f]]=MicroEvent.prototype[c[f]]};ThreeAudio.toTexture=function(a){return ThreeRTT&&ThreeRTT.toTexture&&ThreeRTT.toTexture(a)||a};var \u03c0=Math.PI,\u03c4=2*\u03c0;
ThreeAudio.Source=function(a){"number"==typeof a&&(a={fftSize:a});a=_.extend({fftSize:1024,detectors:[ThreeAudio.LevelDetect,ThreeAudio.BeatDetect]},a);this.fftSize=a.fftSize;this.detectors=a.detectors;this.filters={};this.playing=!1;this.processingDelay=0;if(webkitAudioContext||AudioContext)this.initElement(a.element);else throw"Web Audio API not supported";};
ThreeAudio.Source.prototype={initElement:function(a){var c=this.context=new (webkitAudioContext||AudioContext);a?this.element=a:(this.element=new Audio,this.element.preload="auto");this.samples=this.fftSize/2;this.data={freq:new Uint8Array(this.samples),time:new Uint8Array(this.samples),filter:{bass:new Uint8Array(this.samples),mid:new Uint8Array(this.samples),treble:new Uint8Array(this.samples)}};this.audible=c.createDelayNode();this.inaudible=c.createDelayNode();3<=this.element.readyState?this.initAnalyzer():
this.element.addEventListener("canplay",function(){this.initAnalyzer()}.bind(this))},initAnalyzer:function(){var a=this.context;this.source=a.createMediaElementSource(this.element);this.source.connect(this.audible);this.analyser=a.createAnalyser();var c=this.analyser.fftSize=this.fftSize,f=this.filters;_.each({bass:{type:0,frequency:160,Q:1.2,gain:2},mid:{type:2,frequency:500,Q:1.2,gain:4},treble:{type:1,frequency:2E3,Q:1.2,gain:3}},function(d,e){var g=a.createBiquadFilter();g.key=e;g.type=d.type;
g.frequency.value=d.frequency;g.Q.value=d.Q;g.analyser=a.createAnalyser();g.analyser.fftSize=c;g.delayNode=a.createDelayNode();g.delayNode.delayTime.value=0;g.gainNode=a.createGainNode();g.gainNode.gain.value=d.gain;f[e]=g});this.delay=a.createDelayNode();this.processingDelay=2*this.fftSize/a.sampleRate;this.delay.delayTime.value=this.processingDelay;this.audible.connect(this.analyser);this.inaudible.connect(this.analyser);this.audible.connect(this.delay);this.delay.connect(a.destination);var e=this.audible,
d=this.inaudible;_.each(f,function(a){e.connect(a.delayNode);d.connect(a.delayNode);a.delayNode.connect(a);a.connect(a.gainNode);a.gainNode.connect(a.analyser)});this.detectors=_.map(this.detectors,function(a){return new a(this.data)}.bind(this))},update:function(){var a=this.analyser,c=this.data;a&&(a.smoothingTimeConstant=0,a.getByteFrequencyData(c.freq),a.getByteTimeDomainData(c.time),_.each(this.filters,function(a){a.analyser.getByteTimeDomainData(c.filter[a.key])}),_.each(this.detectors,function(a){a.analyse()}));
return this},size:function(){return this.analyser.frequencyBinCount},mic:function(a){var c=this.context,f=this.inaudible;try{navigator.webkitGetUserMedia({audio:!0},function(d){(this.mediaStreamSource=c.createMediaStreamSource(d)).connect(f);a&&a()})}catch(e){}return this},size:function(){return this.analyser.frequencyBinCount},load:function(a,c){var f=this,e=function(){f.playing&&f._play();f.element.removeEventListener("canplaythrough",e);c&&c()};this.element.addEventListener("canplaythrough",e);
this.element.src=a;return this},play:function(){this.playing=!0;4==this.element.readyState&&this._play();return this},stop:function(){this.playing=!1;4==this.element.readyState&&this._stop();return this},_play:function(){this.startTime=+new Date/1E3-this.element.currentTime;this.element.play()},_stop:function(){this.element.pause()},time:function(){return this.startTime?+new Date/1E3-this.startTime:0}};ThreeAudio.Source.prototype.start=ThreeAudio.Source.prototype.play;
ThreeAudio.Material=function(a,c,f,e,d,n){n=n||[];d=_.extend(d||{},{audioIsBeat:{type:"f",value:0},audioWasBeat:{type:"f",value:0},audioLevels:{type:"fv1",value:[0,0,0,0]},audioLevelsSmooth:{type:"fv1",value:[0,0,0,0]},audioLevelsChange:{type:"fv1",value:[0,0,0,0]},audioOffset:{type:"f",value:0},audioStep:{type:"v2",value:{x:0,y:0}}});_.each(a.get(),function(a,c){var e=new THREE.Texture(new Image,new THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.RepeatWrapping,THREE.NearestFilter,THREE.NearestFilter);
e.__webglInit=!0;e.__webglTexture=a;d[c+"Data"]={type:"t",value:e}});_.each(e||[],function(a,c){d[c]={type:"t",value:ThreeAudio.toTexture(a)}});a.on("update",function(a){_.each(a,function(a,c){d[c].value=a})});return new THREE.ShaderMaterial({attributes:n,uniforms:d,vertexShader:ThreeAudio.getShader(c),fragmentShader:ThreeAudio.getShader(f)})};ThreeAudio.Textures=function(a,c,f){this.renderer=a;this.source=c;this.textures={};this.history=f||128;this.timeIndex=0;this.data=c.data;this.init()};
ThreeAudio.Textures.prototype={init:function(){var a=this.renderer,c=a.getContext(),f=this.textures,e=this.data,d=this.history,n,k,g;_.each(["freq","time"],function(m){f[m]&&(c.deleteTexture(f[m]),a.info.memory.textures--);n=f[m]=c.createTexture();a.info.memory.textures++;c.bindTexture(c.TEXTURE_2D,n);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MAG_FILTER,c.LINEAR);k=e[m];g=new Uint8Array(k.length*d);if("time"==m)for(m=0;m<k.length*d;++m)g[m]=128;c.pixelStorei(c.UNPACK_ALIGNMENT,1);c.texImage2D(c.TEXTURE_2D,0,c.ALPHA,k.length,d,0,c.ALPHA,c.UNSIGNED_BYTE,g)})},update:function(){var a=this.renderer.getContext(),c=this.textures,f=this.source,e=this.history,d=this.timeIndex,n=f.data;f.update();_.each(["freq","time"],function(e){a.bindTexture(a.TEXTURE_2D,c[e]);a.pixelStorei(a.UNPACK_ALIGNMENT,1);a.texSubImage2D(a.TEXTURE_2D,0,0,d,
n[e].length,1,a.ALPHA,a.UNSIGNED_BYTE,n[e])});this.emit("update",this.uniforms());this.timeIndex=(d+1)%e},get:function(){return this.textures},uniforms:function(){var a=this.data.levels,c=this.data.beat;return{audioIsBeat:c&&c.is||0,audioWasBeat:c&&c.was||0,audioLevels:a&&a.direct||0,audioLevelsSmooth:a&&a.smooth||0,audioLevelsChange:a&&a.change||0,audioOffset:this.timeIndex/this.history,audioStep:{x:1/(this.source.samples-1),y:1/this.history}}}};MicroEvent.mixin(ThreeAudio.Textures);
ThreeAudio.GridGeometry=function(a,c,f,e,d){var n=a.source;e=(e||n.samples)-1;d=Math.min(a.history,d||a.history)-1;var k=d/a.history,g=0.5/(n.samples-1);offsetV=0.5/a.history;a=new THREE.PlaneGeometry(c,f,e,d);_.each(a.faceVertexUvs[0],function(a){_.each(a,function(a){a.u+=g;a.v=1-a.v*k+offsetV})});return a};ThreeAudio.LevelDetect=function(a){this.data=a;this.levels=[[0,0,0,0]];this.smooth=[0,0,0,0];this.change=[0,0,0,0];a.levels={direct:this.levels[0],smooth:this.smooth,change:this.change}};
ThreeAudio.LevelDetect.prototype.analyse=function(){for(var a=this.data,c=this.levels,f=this.smooth,e=this.change,d=[0,0,0,0],n=[a.time,a.filter.bass,a.filter.mid,a.filter.treble],a=0;4>a;++a){var k=d,g=a,m;m=n[a];for(var s=m.length,p=0,q=0;q<s;++q)var t=(m[q]-128)/128,p=p+t*t;m=Math.sqrt(p/s);k[g]=m}c.unshift(d);7<c.length&&c.pop();n=[1,2,1];k=4;g=Math.min(c.length,n.length);for(m=0;4>m;++m){for(a=d=0;a<g;++a)d+=(c[a]&&c[a][m]||0)*n[a];f[m]=d/k}n=[1,3,2,-2,-3,-1];k=1;g=Math.min(c.length,n.length);
for(m=0;4>m;++m){for(a=d=0;a<g;++a)d+=(c[a]&&c[a][m]||0)*n[a];e[m]+=0.5*(d/k-e[m])}this.data.levels.direct=this.levels[0]};var __taDebug=!1;
ThreeAudio.BeatDetect=function(a){this.data=a;a.beat={permanence:0,confidence:0,missed:!1,predicted:!1,maybe:!1,is:!1,was:0,stddev:0,bpm:0};__taDebug&&this.initDebug();this.n=512;this.history=[[],[],[]];this.buffer=new Float32Array(this.n);this.spectrum=null;this.fft=new FFT(this.n,44100);this.decay=this.debouncePredict=this.debounceMaybe=this.maxMaybe=this.maybe=this.measure=this.signal=this.energy=this.background=this.sample=0;this.intervals=[];this.jitter=this.stddev=this.mean=0;this.missed=3;
this.found=0;this.predicted=!1;this.green=0;this.fMin=Math.floor(this.bpmToOffset(50));this.fMax=Math.ceil(this.bpmToOffset(400));this.histogram={};this.histogramSorted=[];this.beat=null;this.frames=0};
ThreeAudio.BeatDetect.prototype={initDebug:function(){this.c=document.createElement("canvas");this.c.className="ta-debug";this.c.width=512;this.c.height=340;this.c.style.position="absolute";this.c.style.zIndex=20;this.c.style.marginTop="70px";this.c.style.top=0;this.g=this.c.getContext("2d");this.i=0;this.t=document.createElement("div");this.t.className="ta-debug";this.t.width=256;this.t.height=200;this.t.style.background="rgba(0,0,0,.3)";this.t.style.color="#fff";this.t.style.fontSize="10px";this.t.style.position=
"absolute";this.t.style.zIndex=20;this.t.style.marginTop="350px";this.c.style.top=0;document.body.appendChild(this.c);document.body.appendChild(this.t)},bpmToOffset:function(a){return this.n*a/3600},offsetToBPM:function(a){return 3600*a/this.n},analyse:function(){function a(a){var c=0,d=1.5*a.offset;_.each(m,function(e){if(e!=a&&!(e.offset<d)){var f=e.offset/a.offset,g=Math.max(0,1-4*Math.abs(f-Math.round(f)));w=e.strength*e.permanence*f;c+=g*w}});return c}var c=this.data,f=c.levels,e=this.buffer,
d=this.fft,n=this.n,k=this.history,g=this.histogram,m=this.histogramSorted,s=this;c.beat.missed=!1;c.beat.maybe=!1;c.beat.is=!1;c.beat.predicted=!1;c.beat.locked=!1;c.beat.adjusted=!1;this.beat?(c.beat.confidence=this.beat.confidence,c.beat.permanence=this.beat.permanence,c.beat.bpm=this.beat.bpm):(c.beat.confidence=0,c.beat.permanence=0,c.beat.bpm="");var p=f.direct[0];this.background+=0.2*(p-this.background);this.energy+=0.4*(p-this.energy);this.signal=p=(this.energy-this.background)/(1-this.background)*
3;f=this.maybe;maybe=p;this.maxMaybe=Math.max(0.99*this.maxMaybe,maybe);this.maybe=maybe=maybe/Math.max(0.2,this.maxMaybe)-0.7;this.sample=p;for(k.unshift(p);k.length>n;)k.pop();e.set(k);d.forward(e);for(var q=this.spectrum=d.real,p=d.real,e=d.imag,d=0;d<n;++d)q[d]=p[d]*p[d]+e[d]*e[d];e=0;for(d=2;d<n/8;++d)e=Math.max(e,q[d]);for(var k={},t=e/16,d=this.fMin+1;d<this.fMax;++d)if(p=q[d],p>t){var h=Math.max(q[d-1],q[d+1]);if(p>h&&(h=Math.min(q[d-1],q[d+1]),0.5<Math.abs(p-h)/p)){var w=Math.sqrt(p/e);k[d]=
w}}_.each(m,function(a,c){a.permanence*=0.99;decay=Math.min(1,Math.log(1+a.permanence)/Math.log(10));a.strength*=decay;a.active=!1});_.each(k,function(a,c){c=+c;var d=q[c-1],e=q[c+1],f=d+e-2*q[c];b=(e-d)/2;fraction=-b/f;d=g[c];d||((d=g[c+1])?(delete g[c+1],d.index=c,d.fraction+=1,g[c]=d):(d=g[c-1])?(delete g[c-1],d.index=c,d.fraction-=1,g[c]=d):(d=g[c]={index:c,fraction:fraction,offset:0,strength:0,permanence:0,score:0,window:0},m.push(d)));d.fraction+=0.1*(fraction-d.fraction);d.strength=a;d.permanence+=
0.01*d.strength;d.offset=d.index+d.fraction;d.bpm=s.offsetToBPM(d.offset);d.window=n/d.offset;d.active=!0});m.sort(function(a,c){return c.permanence-a.permanence});for(var r;(r=m[m.length-1])&&0.01>r.strength;)m.splice(m.length-1,1),delete g[r.index];var y=this.fMin,u=0,x=0,z=null;_.each(m,function(c){var d=0;if(!(c.offset<y)){var e=a(c);e>d&&(d=e);d+=c.strength*c.permanence;c.score=d;d>u?(z=c,x=u,u=d):d>x&&(x=d)}});z&&(z.score=u?1-x/u:0,z.confidence=Math.min(1,z.score+z.permanence),this.beat?this.beat.confidence<
z.confidence?this.beat=z:this.beat!=z&&(this.beat.confidence*=0.95):this.beat=z,240<this.beat.bpm&&(this.beat.bpm/=2,this.beat.window*=2));r=this.measure;d=0;this.beat&&(d=this.beat.window,this.mean&&2>this.stddev&&(d=this.mean,c.beat.locked=!0,c.beat.bpm=this.offsetToBPM(this.n/d)));0<maybe&&0>=f&&5<this.debounceMaybe&&(this.debounceMaybe=0,!this.beat||!c.beat.locked&&0.3>this.beat.confidence?(this.measure=0,c.beat.is=!0,c.beat.maybe=!0):this.beat&&(f=this.beat.window/2,f=(this.measure+f)%d-f,p=
this.jitter&&Math.max(3,Math.min(this.jitter+1,10))||10,Math.abs(f)<p?(this.measure=0,1>=f&&5<this.debouncePredict||!this.predicted?(c.beat.is=!0,0<=f&&(c.beat.predicted=!0),this.debouncePredict=0,this.found=Math.min(10,this.found+1),c.beat.adjusted=!0):(c.beat.maybe=!0,this.found=Math.min(10,this.found+1),this.missed=Math.max(0,this.missed-1)),this.found=Math.min(10,this.found+1),this.missed=Math.max(0,this.missed-3)):maybe>1+0.2*this.found+0.5/this.stddev-this.missed/10||0==this.found||4<this.missed?
(this.measure=0,c.beat.is=!0,this.debouncePredict=0,this.found=Math.min(10,this.found+1),this.missed=Math.max(0,this.missed-3)):c.beat.maybe=!0));if(this.beat&&0.3<this.beat.confidence){f=5<this.debouncePredict;if(p=this.measure>=d)this.measure-=d;p&&f&&(0>maybe?(this.found=Math.max(0,this.found-1),this.missed=Math.min(10,this.missed+1),c.beat.missed=!0,c.beat.predicted=!0):(this.found=Math.min(10,this.found+1),this.missed=Math.max(0,this.missed-3)),1>this.found?(p=!1,c.beat.maybe=!0,c.beat.predicted=
!0,this.debouncePredict=0):4<this.missed&&(p=!1,c.beat.maybe=!0,c.beat.predicted=!0,this.measure+=5*Math.random(),this.debounceMaybe+=5*Math.random(),this.debouncePredict=0),this.predicted=p);p&&f&&(this.debouncePredict=0,c.beat.is=!0,c.beat.predicted=!0)}f=0;if(3<this.missed)this.green=0;else if(c.beat.is||c.beat.adjusted)this.green++&&(f=this.frames-this.lastGreen),this.lastGreen=this.frames;if(f&&(f=this.intervals,f.unshift(r),12<f.length&&f.pop(),f=f.slice(),f.sort(),f=f.slice(2,10),6<f.length)){p=
r=0;l=f.length;for(d=0;d<l;++d)r+=f[d],p+=f[d]*f[d];r/=l;p/=l;this.mean=r;this.stddev=Math.sqrt(p-r*r)}this.jitter=(this.stddev+0.5*this.missed)*(1+this.missed);this.decay+=0.4*(2.5*+c.beat.is-this.decay);c.beat.was+=0.4*(2.5*this.decay-c.beat.was);this.debounceMaybe++;this.debouncePredict++;this.measure++;this.frames++;__taDebug&&this.debug()},debug:function(){function a(a){a=Math.round(Math.max(0,Math.min(255,255*a)));h.fillStyle="rgb("+[a,a,a].join()+")";h.fillRect(r,y,1,20);y+=20}var c=this.data.levels.direct,
f=this.sample,e=this.signal,d=this.maybe,n=this.spectrum,k=this.histogram,g=this.data.beat,m=this,s=this.n;if(this.beat){var p=this.beat,q=1.5*p.offset;_.each(k,function(a){var c=a==p?1:0;a.offset>q&&(c=a.offset/p.offset,c=Math.max(0,1-4*Math.abs(c-Math.round(c))));a.match=c})}var t=["<strong><span"+(g.locked?' style="color: rgb(180,255,0)"':"")+">"+Math.round(10*g.bpm)/10+" BPM </span> ("+Math.round(100*g.confidence)+"%) P:"+Math.round(100*g.permanence)+" \u00b5 = "+Math.round(10*this.mean)/10+" \u03c3 = "+
Math.round(100*this.stddev)/100+"</strong> "+this.found+"f "+this.missed+"m"];_.each(k,function(a){var c=Math.round(10*m.offsetToBPM(a.offset))/10;t.push([c," bpm - ",Math.round(100*a.strength),"% P: ",Math.round(100*a.permanence)].join(""))});this.t.innerHTML=t.join("<br>");var h=this.g;h.fillStyle="#000000";h.fillRect(0,169,512,102);for(var w=0,r=2;r<s/8;++r)w=Math.max(n[r],w);w=1/w;h.beginPath();h.moveTo(0,270);for(r=2;r<s/8;++r)h.lineTo(8*(r-2),270-n[r]*w*100);h.strokeStyle="#ffffff";h.stroke();
_.each(k,function(a){var c=0.75*a.strength+0.25,d=a.active?[Math.round(255-195*a.match),Math.round(180+40*a.match),0].join():"255,10,10";h.fillStyle="rgba("+d+","+c+")";h.fillRect(8*(a.offset-2),170,1,100)});var r=this.i,y=0;a(c[1]);a(c[2]);a(c[3]);a(0);a(0);a(0);a(0);a(0);h.fillStyle="rgba(160,160,255,.85)";h.fillRect(r+1,0,2,120);g.is&&(h.fillStyle=g.missed?"rgba(255,0,0,.7)":g.maybe?"rgba(0,180,255,.9)":g.predicted?"rgba(255,200,0,1)":"rgba(60,220,0,1)",h.fillRect(this.i,120,2,40));c=Math.round(Math.max(0,
Math.min(255,255*g.was)));h.fillStyle="rgb("+c+","+c+","+c+")";h.fillRect(342,270,170,30);g.maybe&&!g.is&&(h.fillStyle="rgba(64,64,64,.75)",h.fillRect(this.i,120,2,40));f=Math.floor(255*Math.max(0,Math.min(1,1.4*f+0.5)));h.fillStyle="rgba("+Math.round(0.2*f)+","+Math.round(0.6*f)+","+f+",1)";h.fillRect(this.i,60,1,20);e=Math.floor(255*Math.max(0,Math.min(1,2*e)));h.fillStyle="rgba("+Math.round(0.2*e)+","+Math.round(e)+","+Math.round(0.5*e)+",1)";h.fillRect(this.i,80,1,20);d=g.is||g.maybe?Math.floor(255*
Math.max(0,Math.min(1,1.2*d+0.5))):0;h.fillStyle="rgba("+Math.round(d)+","+d+","+Math.round(d)+",1)";h.fillRect(this.i,100,1,20);this.i=(r+1)%512}};tQuery.World.registerInstance("audio",function(a,c,f){return tQuery.createAudioSource(this,a)});tQuery.registerStatic("createAudioSource",function(a,c,f,e){c=new ThreeAudio.Source(c,f,e);c.textures=function(c){return tQuery.createAudioTextures(a,this,c)};return c});
tQuery.registerStatic("createAudioTextures",function(a,c,f){var e=new ThreeAudio.Textures(a.tRenderer(),c,f);e.material=function(a,c,e,f,m){return tQuery.createAudioMaterial(this,a,c,e,f,m)};a.loop().hookPreRender(function(){e.update()});return e});tQuery.registerStatic("createAudioMaterial",function(a,c,f,e,d,n){c=new ThreeAudio.Material(a,c,f,e,d,n);c.grid=function(c,d,e,f){return tQuery.createAudioGrid(a,c,d,e,f,this)};return c});
tQuery.registerStatic("createAudioGrid",function(a,c,f,e,d,n){var k=[a,1,1,0,0];for(i in k)arguments[i]=arguments[i]||k[i];k=new ThreeAudio.GridGeometry(a,c||1,f||1,e,d);n=n||tQuery.defaultObject3DMaterial;k=new THREE.Mesh(k,n);k.doubleSided=!0;k.frustumCulled=!1;return tQuery(k)});
